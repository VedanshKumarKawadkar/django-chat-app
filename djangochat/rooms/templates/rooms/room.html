{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ room.name }} | {% endblock %}

{% block css_files %} <link rel="stylesheet" href="{% static 'rooms/room.css' %}"> {% endblock %}

{% block content %}

<div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
    <a href="/">Home</a>
    <a href="#">Other Rooms</a>
    {% for r in rooms %}
        <h3><a href="{% url 'room' r.room.slug %}">{{ r.room.name }}</a></h3>
    {% endfor %}
</div>

<button class="openbtn" onclick="openNav()">☰</button>  

<div class="room-heading">
    <a class="dropdown-btn" onclick="toggleDropdown()" id="room-desc"><h1>{{ room.name }}</h1></a>

    <div class="about-room-modal" id="about-room-modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h1>{{ room.name }}</h1>
            
            <label for="room-desc">About the room</label>
            <p>{{ room.description }}</p>
            
            <label for="participants-list">All Participants</label>
            <ul>
                <li>
                    {% for participant in participants %}
                    {{ participant.username }}
                    {% endfor%}
                </li>
            </ul>
        </div>
    </div>
</div>

{% if has_permission %}
<div class="chat-messages-container">
    <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
        <div class="chat-message-box">
            <p class="font-semibold">{{ message.user.username }}</p>
            <p id="chat-message">{{ message.message_text }}</p> 
        </div>
        {% endfor %}
    </div>
</div> 

<div class="chat-msg-input-container">
    <form action="." method="post" class="flex">
        <textarea name="content" id="chat-msg-input" class="flex-1 mr-3" placeholder="Your message..."></textarea>
        <button class="chat-msg-send" id="chat-msg-send">Send</button>
    </form>
</div>

{% else %}
<h1>Permission denied for this room!</h1>
{% endif %}

{% endblock %}


{% block scripts %}
{{ request.user.username|json_script:"json-username" }}
{{ room.slug|json_script:"json-roomname" }}
{{ request.session.get_expiry_age|json_script:"json-expiry" }}
<script>
    /////////////////----Room desc modal ----/////////////////// 

    var modal = document.getElementById("about-room-modal");
    var btn = document.getElementById("room-desc");
    var span = document.getElementsByClassName("close")[0];

    btn.onclick = function() {
        modal.style.display = "block";
    }

    span.onclick = function() {
        span.style.display = "none";
    }

    window.onclick = function(e) {
        if(e.target==modal) {
            modal.style.display = "none";
        }
    }

    /////////////////----Side bar navigation----/////////////////// 

    function openNav() {
        document.getElementById("mySidebar").style.width = "250px";
        document.getElementById("main").style.marginLeft = "250px";
    }
    
    function closeNav() {
        document.getElementById("mySidebar").style.width = "0";
        document.getElementById("main").style.marginLeft= "0";
    }

    /////////////////----Chat Web Socket----/////////////////// 

    const roomName = JSON.parse(document.getElementById('json-roomname').textContent);
    const userName = JSON.parse(document.getElementById('json-username').textContent);
    const expiry = JSON.parse(document.getElementById('json-expiry').textContent);

    const chatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/'
        + roomName
        + '/'
    );


    chatSocket.onmessage = function(e) {
        console.log('onmessage')
        console.log(expiry)
        const data = JSON.parse(e.data);
        if(data.message){
            let html_content = '<div class="p-4 bg-gray-200 rounded-xl" id="chat-msg-input">';
                html_content+='<p class="font-semibold">'+data.username+'</p>';
                html_content+='<p>'+data.message+'</p></div>';
            console.log(html_content)
            document.querySelector("#chat-messages").innerHTML+=html_content;

            scrollToBottom()

        }
        else{
            alert("Please type something!")
        }

    };

    chatSocket.onclose = function(e) {
        console.log('onclosed')
    };

    document.querySelector('#chat-msg-send').onclick = function(e){
        e.preventDefault();

        const messageInputDom = document.querySelector("#chat-msg-input");
        const message = messageInputDom.value;

        chatSocket.send(JSON.stringify({
            "message":message,
            "username":userName,
            "room":roomName
        }));

        messageInputDom.value = "";

        return false;
    };

    function scrollToBottom(){
        const objDiv = document.querySelector("#chat-messages");
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    scrollToBottom()
</script>
{% endblock %}